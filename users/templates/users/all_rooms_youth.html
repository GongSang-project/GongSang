{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=375, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì˜ ë§ëŠ” ë°© ì¶”ì²œ | ì „ì²´ {{ recommended_rooms|length }}ê°œ</title>
  <style>
    :root{
      --bg:#f3f3f3; --white:#fff; --black:#121212;
      --gray-500:#959595; --line:#e8e8e8; --shadow:0 0 10px #0000001a;
      --orange:#F26430; --peach-strong:#ffebd9;
      --blue-soft:#BAD7FF; --blue-text:#0C3281; --sheet-radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--black);
      font-family:Pretendard,-apple-system,system-ui,Segoe UI,Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;}
    .app{width:375px;min-height:812px;margin:0 auto;background:var(--bg);}
    /* Header */
    .header{position:sticky;top:0;z-index:10;background:var(--white);box-shadow:var(--shadow);border-radius:12px 12px 0 0;padding-top:6px;}
    .head-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 12px;}
    .head-left{display:flex;align-items:center;gap:12px;}
    .back-btn{width:32px;height:32px;border:none;background:transparent;padding:0;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .back-btn svg{width:10px;height:17px}.back-btn path{stroke:var(--black);stroke-width:1.5;fill:none;stroke-linecap:round;stroke-linejoin:round;}
    .title{font-size:18px;font-weight:700;letter-spacing:-0.1px;}
    .head-right{display:flex;align-items:flex-end;gap:8px;color:var(--gray-500);font-size:12px;}
    .sep{color:#d0d0d0;margin:0 4px;font-weight:400;}
    /* Filter chips */
    .filters{display:flex;gap:8px;padding:10px 16px 12px;background:var(--white);border-top:1px solid #fff;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 11px;border-radius:100px;border:1px solid #e7e7e7;background:var(--white);font-size:12px;color:var(--gray-500);cursor:pointer;}
    .chip .caret{width:9px;height:6px}.chip .caret path{stroke:#999;stroke-width:1.2;fill:none;stroke-linecap:round;stroke-linejoin:round;}
    /* List */
    .list{padding:10px 17px 18px;display:flex;flex-direction:column;gap:12px;}
    .card{position:relative;background:var(--white);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:grid;grid-template-columns:135px 1fr;min-height:195px;}
    .card-left{position:relative;width:135px;height:173px;margin:11px 0 11px 12px;border-radius:6px;overflow:hidden;background:#d1d1d1;}
    .thumb{position:absolute;inset:0}.thumb img{width:100%;height:100%;object-fit:cover;}
    .dot-row{position:absolute;left:0;right:0;bottom:6px;display:flex;gap:4px;justify-content:center}
    .dot{width:5px;height:5px;border-radius:50%;background:#c1c1c1}.dot.active{background:#fff}
    .like{position:absolute;right:8px;top:8px;width:27px;height:27px;display:grid;place-items:center;background:rgba(255,255,255,.92);border-radius:50%;border:1px solid #eee;cursor:pointer}
    .like svg{width:16px;height:16px}.like path{stroke:#999;fill:none;stroke-width:1.5}.like.active path{fill:#ff6a6a;stroke:#ff6a6a}
    .card-right{padding:15px 12px 12px 12px;display:flex;flex-direction:column;gap:8px}
    .score{font-size:15px;font-weight:600}.price{font-size:15px;font-weight:700}
    .meta{color:#9a9a9a;font-size:12px;line-height:16px}
    .host{display:flex;align-items:center;gap:6px;color:#9a9a9a;font-size:12px}
    .trial{display:inline-flex;align-items:center;gap:4px;height:20px;padding:0 6px;background:var(--blue-soft);color:var(--blue-text);border-radius:6px;font-size:11px;font-weight:600;width:max-content}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{display:inline-flex;align-items:center;height:20px;padding:0 6px;background:var(--peach-strong);color:var(--orange);border-radius:6px;font-size:11px;font-weight:600}
    .card a.card-link{position:absolute;inset:0;z-index:1}.card .click-surface{position:relative;z-index:2}
    /* Bottom sheets */
    .sheet-backdrop{position:fixed;inset:0;background:#0006;opacity:0;visibility:hidden;transition:.2s;z-index:20}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:var(--sheet-radius);border-top-right-radius:var(--sheet-radius);box-shadow:0 -8px 30px #0002;transition:.3s;z-index:21}
    .sheet.open{bottom:0}.sheet-head{padding:14px 18px 6px;border-bottom:1px solid #f1f1f1}
    .sheet-title{margin:0;font-size:16px;font-weight:700}.sheet-body{padding:14px 18px 18px;display:grid;gap:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}.chip-option{padding:8px 12px;border-radius:10px;border:1px solid #eee;background:#f27d5b18;cursor:pointer}
    .chip-option.active{border-color:var(--orange);background:#ffece7}
    .section label{display:block;margin-bottom:6px;font-weight:600}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}.row input{width:100%;padding:10px;border:1px solid #eee;border-radius:10px}
    .sheet-foot{padding:12px 18px 18px;border-top:1px solid #f4f4f4;display:flex;gap:10px}
    .sheet-foot button{flex:1;padding:12px;border-radius:12px;border:1px solid #eee;cursor:pointer;font-weight:600}
    .sheet-foot .ok{background:var(--orange);color:#fff;border-color:var(--orange)}
  </style>
</head>
<body>
<div class="app">

  <!-- ===== Header ===== -->
  <div class="header">
    <div class="head-row">
      <div class="head-left">
        <button class="back-btn" type="button" aria-label="ë’¤ë¡œê°€ê¸°" onclick="history.back()">
          <svg viewBox="0 0 8 13" xmlns="http://www.w3.org/2000/svg"><path d="M6.84 1.5 1.155 6.711 6.84 11.923"/></svg>
        </button>
        <div class="title">ì˜ ë§ëŠ” ë°© ì¶”ì²œ</div>
      </div>
      <div class="head-right">
        <span class="sep">|</span>
        <div>ì „ì²´ <span id="resultCount">{{ recommended_rooms|length }}</span>ê°œ</div>
      </div>
    </div>

    <!-- ì¹© + íˆë“  ì¿¼ë¦¬ (ê³µìœ /ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„) -->
    <form id="filterForm" method="get">
      <input type="hidden" name="property_type" id="q_type">
      <input type="hidden" name="deal_types" id="q_deals">
      <input type="hidden" name="deposit_min" id="q_dep_min">
      <input type="hidden" name="deposit_max" id="q_dep_max">
      <input type="hidden" name="rent_min" id="q_rent_min">
      <input type="hidden" name="rent_max" id="q_rent_max">
      <input type="hidden" name="move_in_from" id="q_move">
    </form>

    <div class="filters">
      <button type="button" class="chip" id="btnType">
        <span>ë§¤ë¬¼ìœ í˜•</span>
        <span class="caret"><svg viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l4 4 4-4"/></svg></span>
      </button>
      <button type="button" class="chip" id="btnDeal">
        <span>ê±°ë˜ìœ í˜•/ê°€ê²©</span>
        <span class="caret"><svg viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l4 4 4-4"/></svg></span>
      </button>
      <button type="button" class="chip" id="btnDate">
        <span>ì…ì£¼ ë‚ ì§œ</span>
        <span class="caret"><svg viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg"><path d="M1 1l4 4 4-4"/></svg></span>
      </button>
    </div>
  </div>

  <!-- ===== List ===== -->
  <div class="list" id="roomList">
    {% if recommended_rooms %}
      {% for room in recommended_rooms %}
        <div class="card"
             data-type="{{ room.property_type|default:'ì•„íŒŒíŠ¸' }}"
             data-trial="{% if room.can_short_term %}1{% else %}0{% endif %}"
             data-deposit="{{ room.deposit|floatformat:0 }}"
             data-rent="{{ room.rent_fee|floatformat:0 }}"
             {% if room.move_in_from %}data-move="{{ room.move_in_from|date:'Y-m-d' }}"{% endif %}>
          <a href="{% url 'room:room_detail' room.id %}" class="card-link" aria-label="ìƒì„¸ë³´ê¸°ë¡œ ì´ë™"></a>

          <!-- left -->
          <div class="card-left click-surface">
            <div class="thumb">
              {% if room.thumbnail_url %}
                <img src="{{ room.thumbnail_url }}" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
              {% elif room.images and room.images.0 %}
                <img src="{{ room.images.0.url }}" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
              {% else %}
                <img src="{% static 'img/placeholder_room.jpg' %}" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
              {% endif %}
            </div>

            <!-- like -->
            <button class="like" type="button" aria-label="ê´€ì‹¬">
              <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-.99-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.77-8.84a5.5 5.5 0 0 0 .07-7.78Z"/></svg>
            </button>

            <!-- dots -->
            <div class="dot-row">
              <span class="dot active"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
          </div>

          <!-- right -->
          <div class="card-right click-surface">
            <div class="score">ì„±í–¥ ë§¤ì¹­ ì ìˆ˜ {{ room.matching_score }}ì </div>
            <div class="price">ì›”ì„¸ {{ room.deposit|floatformat:0 }}/{{ room.rent_fee|floatformat:0 }}</div>

            <div class="meta">
              {{ room.address_city }} {{ room.address_district }}<br/>
              {{ room.property_type|default:"ì•„íŒŒíŠ¸" }}
              {% if room.floor %} {{ room.floor }}ì¸µ,{% endif %}
              ë°© {{ room.area|floatformat:1 }}mÂ²
            </div>

            <div class="host">
              <span>{% if room.owner.gender == 'F' %}ğŸ‘µ{% else %}ğŸ‘´{% endif %}</span>
              <span>
                {% if room.owner_living_status %}
                  {{ room.owner_living_status }}
                {% elif room.owner.gender == 'F' %}
                  ì—¬ì„± ì‹œë‹ˆì–´
                {% elif room.owner.gender == 'M' %}
                  ë‚¨ì„± ì‹œë‹ˆì–´
                {% else %}
                  ì‹œë‹ˆì–´
                {% endif %}
              </span>
            </div>

            {% if room.can_short_term %}
              <div class="trial">ì²´í—˜ ì…ì£¼ ê°€ëŠ¥</div>
            {% endif %}

            <div class="tags">
              {% if room.tags %}
                {% for t in room.tags|slice:":3" %}<span class="tag">#{{ t }}</span>{% endfor %}
              {% elif room.preferences %}
                {% for t in room.preferences|slice:":3" %}<span class="tag">#{{ t }}</span>{% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p style="color:#666;text-align:center;margin:24px 0;">ê´€ì‹¬ ì§€ì—­ì— í•´ë‹¹í•˜ëŠ” ë°©ì´ ì—†ê±°ë‚˜, AI ì¶”ì²œì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- ===== Bottom Sheets ===== -->
  <!-- ë§¤ë¬¼ìœ í˜• -->
  <div class="sheet-backdrop" id="backdropType" hidden></div>
  <div class="sheet" id="sheetType" aria-hidden="true">
    <div class="sheet-head"><h3 class="sheet-title">ë§¤ë¬¼ ìœ í˜•</h3></div>
    <div class="sheet-body">
      <div class="chips" id="typeChips">
        <span class="chip-option" data-value="">ì „ì²´</span>
        <span class="chip-option" data-value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</span>
        <span class="chip-option" data-value="ë¹Œë¼">ë¹Œë¼</span>
        <span class="chip-option" data-value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</span>
        <span class="chip-option" data-value="ì£¼íƒ">ì£¼íƒ</span>
      </div>
    </div>
    <div class="sheet-foot">
      <button type="button" data-reset-type>ì´ˆê¸°í™”</button>
      <button type="button" class="ok" data-apply-type>í™•ì¸</button>
    </div>
  </div>

  <!-- ê±°ë˜ìœ í˜•/ê°€ê²© -->
  <div class="sheet-backdrop" id="backdropDeal" hidden></div>
  <div class="sheet" id="sheetDeal" aria-hidden="true">
    <div class="sheet-head"><h3 class="sheet-title">ê±°ë˜ ë°©ì‹ Â· ê°€ê²©</h3></div>
    <div class="sheet-body">
      <div class="section">
        <label>ê±°ë˜ ë°©ì‹ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
        <div class="chips" id="dealChips">
          <span class="chip-option" data-value="ì²´í—˜ì…ì£¼">ì²´í—˜ ì…ì£¼</span>
          <span class="chip-option" data-value="ì›”ì„¸">ì›”ì„¸</span>
        </div>
      </div>
      <div class="section">
        <label>ë³´ì¦ê¸ˆ (ë§Œì›)</label>
        <div class="row">
          <input type="number" id="inpDepMin" placeholder="ìµœì†Œ">
          <input type="number" id="inpDepMax" placeholder="ìµœëŒ€">
        </div>
      </div>
      <div class="section">
        <label>ì›”ì„¸ (ë§Œì›)</label>
        <div class="row">
          <input type="number" id="inpRentMin" placeholder="ìµœì†Œ">
          <input type="number" id="inpRentMax" placeholder="ìµœëŒ€">
        </div>
      </div>
    </div>
    <div class="sheet-foot">
      <button type="button" data-reset-deal>ì´ˆê¸°í™”</button>
      <button type="button" class="ok" data-apply-deal>í™•ì¸</button>
    </div>
  </div>

  <!-- ì…ì£¼ ë‚ ì§œ -->
  <div class="sheet-backdrop" id="backdropDate" hidden></div>
  <div class="sheet" id="sheetDate" aria-hidden="true">
    <div class="sheet-head"><h3 class="sheet-title">ì…ì£¼ ë‚ ì§œ</h3></div>
    <div class="sheet-body">
      <div class="row"><input type="date" id="inpMoveIn"></div>
    </div>
    <div class="sheet-foot">
      <button type="button" data-reset-date>ì´ˆê¸°í™”</button>
      <button type="button" class="ok" data-apply-date>í™•ì¸</button>
    </div>
  </div>
</div>

<script>
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // like toggle
  $$(".like").forEach(b=> b.addEventListener("click", e=>{ e.stopPropagation(); b.classList.toggle("active"); }));

  // Bottom sheet helpers
  function openSheet(id){ $("#"+id).classList.add("open"); const bd=$("#backdrop"+id.replace("sheet","")); bd.hidden=false; bd.style.opacity=1; bd.style.visibility='visible'; }
  function closeSheet(id){ $("#"+id).classList.remove("open"); const bd=$("#backdrop"+id.replace("sheet","")); bd.style.opacity=0; setTimeout(()=>{bd.hidden=true; bd.style.visibility='hidden';},200); }

  // State
  const state = {
    type: "",                 // ì•„íŒŒíŠ¸/ë¹Œë¼/...
    deals: new Set(),         // ì²´í—˜ì…ì£¼, ì›”ì„¸
    depMin: "", depMax: "",
    rentMin: "", rentMax: "",
    moveFrom: ""              // YYYY-MM-DD
  };

  // Apply filters to cards (frontend filtering)
  function applyFilters(){
    const cards = $$("#roomList .card");
    let visible = 0;

    cards.forEach(card=>{
      const type   = card.dataset.type || "";
      const trial  = card.dataset.trial === "1";
      const dep    = Number(card.dataset.deposit || 0);
      const rent   = Number(card.dataset.rent || 0);
      const move   = card.dataset.move || ""; // ì—†ìœ¼ë©´ íŒ¨ìŠ¤

      let ok = true;

      // type
      if(state.type && state.type !== type) ok = false;

      // deals (OR semantics)
      if(ok && state.deals.size){
        let hit = false;
        if(state.deals.has("ì›”ì„¸")) hit = true;            // í˜ì´ì§€ê°€ ì›”ì„¸ ì¹´ë“œì´ë¯€ë¡œ í•­ìƒ í†µê³¼
        if(state.deals.has("ì²´í—˜ì…ì£¼") && trial) hit = true;
        ok = hit;
      }

      // deposit / rent
      if(ok && state.depMin) ok = dep >= Number(state.depMin);
      if(ok && state.depMax) ok = dep <= Number(state.depMax);
      if(ok && state.rentMin) ok = rent >= Number(state.rentMin);
      if(ok && state.rentMax) ok = rent <= Number(state.rentMax);

      // move in date (ì¹´ë“œì— ê°’ì´ ì—†ìœ¼ë©´ í†µê³¼)
      if(ok && state.moveFrom && move) ok = move >= state.moveFrom;

      card.style.display = ok ? "" : "none";
      if(ok) visible++;
    });

    // í—¤ë” ê°œìˆ˜ ê°±ì‹ 
    $("#resultCount").textContent = visible;

    // íˆë“ ì¿¼ë¦¬(ê³µìœ /ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
    $("#q_type").value = state.type;
    $("#q_deals").value = Array.from(state.deals).join(",");
    $("#q_dep_min").value = state.depMin;
    $("#q_dep_max").value = state.depMax;
    $("#q_rent_min").value = state.rentMin;
    $("#q_rent_max").value = state.rentMax;
    $("#q_move").value = state.moveFrom;
  }

  // ====== Type sheet ======
  $("#btnType").addEventListener("click", ()=> openSheet("sheetType"));
  $("#backdropType").addEventListener("click", ()=> closeSheet("sheetType"));
  $$("#typeChips .chip-option").forEach(ch=>{
    ch.addEventListener("click", ()=>{ $$("#typeChips .chip-option").forEach(x=>x.classList.remove("active")); ch.classList.add("active"); });
  });
  document.querySelector("[data-reset-type]").addEventListener("click", ()=>{
    $$("#typeChips .chip-option").forEach(x=> x.classList.remove("active"));
    state.type = ""; applyFilters();
  });
  document.querySelector("[data-apply-type]").addEventListener("click", ()=>{
    const act = $("#typeChips .chip-option.active");
    state.type = act ? act.dataset.value : "";
    applyFilters(); closeSheet("sheetType");
  });

  // ====== Deal/Price sheet ======
  $("#btnDeal").addEventListener("click", ()=> openSheet("sheetDeal"));
  $("#backdropDeal").addEventListener("click", ()=> closeSheet("sheetDeal"));
  $$("#dealChips .chip-option").forEach(ch=>{
    ch.addEventListener("click", ()=> ch.classList.toggle("active"));
  });
  document.querySelector("[data-reset-deal]").addEventListener("click", ()=>{
    $$("#dealChips .chip-option").forEach(x=> x.classList.remove("active"));
    $("#inpDepMin").value = $("#inpDepMax").value = $("#inpRentMin").value = $("#inpRentMax").value = "";
    state.deals.clear(); state.depMin = state.depMax = state.rentMin = state.rentMax = "";
    applyFilters();
  });
  document.querySelector("[data-apply-deal]").addEventListener("click", ()=>{
    state.deals = new Set($$("#dealChips .chip-option.active").map(x=>x.dataset.value));
    state.depMin = $("#inpDepMin").value; state.depMax = $("#inpDepMax").value;
    state.rentMin = $("#inpRentMin").value; state.rentMax = $("#inpRentMax").value;
    applyFilters(); closeSheet("sheetDeal");
  });

  // ====== Date sheet ======
  $("#btnDate").addEventListener("click", ()=> openSheet("sheetDate"));
  $("#backdropDate").addEventListener("click", ()=> closeSheet("sheetDate"));
  document.querySelector("[data-reset-date]").addEventListener("click", ()=>{
    $("#inpMoveIn").value = ""; state.moveFrom = ""; applyFilters();
  });
  document.querySelector("[data-apply-date]").addEventListener("click", ()=>{
    state.moveFrom = $("#inpMoveIn").value; applyFilters(); closeSheet("sheetDate");
  });

  // ì´ˆê¸° ì ìš©
  applyFilters();

  // ì¹´ë“œ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ ì‹œ ë§í¬íƒ­ ë°©ì§€
  $$(".card .click-surface button").forEach(b=> b.addEventListener("click", e=> e.stopPropagation()));
</script>
</body>
</html>
