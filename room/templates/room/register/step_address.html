<!-- templates/room/register/step_address.html -->
<h1>2/9 집의 위치를 알려주세요</h1>

{% if error %}
  <div style="color:#c00;margin-bottom:8px;">{{ error }}</div>
{% endif %}

{% if addr_tree_empty %}
  <div style="background:#fff3cd; border:1px solid #ffeeba; color:#856404; padding:10px; border-radius:8px; margin-bottom:10px;">
    주소 데이터가 비어 있습니다. CSV를 <code>{{ addr_csv_path }}</code> 경로에 두었는지 확인하세요
    (또는 <code>settings.LEGALADDR_CSV_PATH</code> 설정).
  </div>
{% endif %}

<form method="post" id="addrForm" autocomplete="off">
  {% csrf_token %}

  <!-- 시/도 -->
  <div class="row">
    <label for="sido">시/도</label>
    <select id="sido" name="address_province" required disabled>
      <option value="">시/도를 선택하세요</option>
    </select>
  </div>

  <!-- 구/군 -->
  <div class="row">
    <label for="sigungu">구/군</label>
    <select id="sigungu" name="address_city" required disabled>
      <option value="">구/군을 선택하세요</option>
    </select>
  </div>

  <!-- 동/읍/면 -->
  <div class="row">
    <label for="dong">동/읍/면</label>
    <select id="dong" name="address_district" required disabled>
      <option value="">동/읍/면을 선택하세요</option>
    </select>
  </div>

  <!-- 상세주소 -->
  <div class="row">
    <label for="addrDetail">상세주소</label>
    <input id="addrDetail" type="text" name="address_detailed"
           placeholder="도로명/지번 + 동/호" required>
  </div>

  <!-- 가까운 지하철역 (선택) -->
  <div class="row">
    <label for="nearest">가까운 지하철역 (선택)</label>
    <input id="nearest" type="text" name="nearest_subway" placeholder="예: 경복궁역">
  </div>

  <button type="submit" id="submitBtn" class="btn-primary" disabled>계속</button>
</form>

<!-- 뷰에서 내려준 CSV→트리 JSON -->
<script id="addr-data" type="application/json">{{ addr_tree_json|safe }}</script>

<style>
  .row{display:flex;gap:10px;align-items:center;margin:8px 0}
  label{width:130px;color:#444}
  select,input[type="text"]{flex:1;padding:10px 12px;border:1px solid #ccc;border-radius:10px}
  .btn-primary{margin-top:12px;padding:10px 16px;border:1px solid #0a66ff;border-radius:10px;background:#0a66ff;color:#fff;cursor:pointer}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed}
</style>

<script>
(function(){
  const $sido    = document.getElementById('sido');
  const $sigungu = document.getElementById('sigungu');
  const $dong    = document.getElementById('dong');
  const $detail  = document.getElementById('addrDetail');
  const $submit  = document.getElementById('submitBtn');

  // 1) 트리 로드
  let tree = {};
  try {
    const txt = document.getElementById('addr-data').textContent || '{}';
    tree = JSON.parse(txt);
  } catch (e) {
    console.error('주소 데이터 파싱 오류', e);
    tree = {};
  }

  function clear(sel, placeholder){
    sel.innerHTML = '';
    const op = document.createElement('option');
    op.value = ''; op.textContent = placeholder;
    sel.appendChild(op);
  }
  function fill(sel, arr){
    (arr || []).forEach(v=>{
      const op = document.createElement('option');
      op.value = v; op.textContent = v;
      sel.appendChild(op);
    });
  }
  function updateSubmit(){
    const ok = $sido.value && $sigungu.value && $dong.value && $detail.value.trim();
    $submit.disabled = !ok;
  }

  // 2) 초기 로드: 시/도 옵션 채우기
  (function init(){
    clear($sido, '시/도를 선택하세요');
    const sidos = Object.keys(tree).sort();
    fill($sido, sidos);
    $sido.disabled = (sidos.length === 0);

    // 서버 initial 값 복원
    const iS = "{{ form.initial.address_province|default_if_none:'' }}";
    const iG = "{{ form.initial.address_city|default_if_none:'' }}";
    const iD = "{{ form.initial.address_district|default_if_none:'' }}";
    const iDetail = "{{ form.initial.address_detailed|default_if_none:'' }}";

    if (iS && tree[iS]){
      $sido.value = iS;
      onSidoChange(true);
      if (iG && tree[iS][iG]){
        $sigungu.value = iG;
        onSigunguChange(true);
        if (iD){ $dong.value = iD; }
      }
    }
    if (iDetail){ $detail.value = iDetail; }
    updateSubmit();
  })();

  // 3) 시/도 선택 → 구/군 채우기 (동기)
  function onSidoChange(silent=false){
    clear($sigungu, '구/군을 선택하세요');
    clear($dong, '동/읍/면을 선택하세요');
    $sigungu.disabled = true; $dong.disabled = true;

    const s = $sido.value;
    if (!s || !tree[s]) { updateSubmit(); return; }

    const sigungus = Object.keys(tree[s]).sort();
    fill($sigungu, sigungus);
    $sigungu.disabled = (sigungus.length === 0);
    if (!silent && !$sigungu.disabled) $sigungu.focus();
    updateSubmit();
  }
  $sido.addEventListener('change', function(){ onSidoChange(); });

  // 4) 구/군 선택 → 동/읍/면 채우기 (동기)
  function onSigunguChange(silent=false){
    clear($dong, '동/읍/면을 선택하세요');
    $dong.disabled = true;

    const s = $sido.value, g = $sigungu.value;
    if (!s || !g || !tree[s] || !tree[s][g]) { updateSubmit(); return; }

    const dongs = (tree[s][g] || []).slice();
    fill($dong, dongs);
    $dong.disabled = (dongs.length === 0);
    if (!silent && !$dong.disabled) $dong.focus();
    updateSubmit();
  }
  $sigungu.addEventListener('change', function(){ onSigunguChange(); });

  // 5) 나머지
  $dong.addEventListener('change', updateSubmit);
  $detail.addEventListener('input', updateSubmit);

  // Enter로도 제출 가능 (상세주소 칸)
  $detail.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !$submit.disabled){
      e.preventDefault();
      e.currentTarget.form.submit();
    }
  });
})();
</script>
