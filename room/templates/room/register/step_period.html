{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>방 등록 - 5. 거주 기간</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="{% static 'users/css/survey_form.css' %}">
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

    :root{
      --orange:#F26430;
      --orange-weak:#FFE3D1;
      --black:#121212;
      --disabled:#959595;
      --page-w:375px;
    }

    *{box-sizing:border-box}
    body{margin:0;background:#000;font-family:'Pretendard',system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
    #root{width:var(--page-w);height:812px;margin:0 auto;background:#fff;position:relative;overflow:hidden}
    /* ✅ fixed 기준을 app-wrapper로 만들기 */
    #app-wrapper{  scrollbar-width: none; 
  -ms-overflow-style: none;  overflow-y: hidden; overflow: hidden; width:100%;height:100%;position:relative;transform:translateZ(0)}

    /* 공통 헤더/문구 좌표 */
    .header{position:sticky;top:0;height:102.94px;background:#fff;z-index:100}
    .back-btn{appearance:none;background:none;border:0;cursor:pointer;position:absolute;left:20.6133px;top:54px}
    .back-btn img{width:20px;height:27px;padding:6px}
    .title{position:absolute;top:60px;left:143px;margin:0;color:var(--black);font-size:20px;font-weight:500;line-height:15px;white-space:nowrap}

    .num{position:absolute; top:126.75px; left:24px; margin:0; color:#515151; font-size:15px; font-weight:500}
    .qu-wrapper{display:flex; flex-direction:column; gap:25px; position:absolute; top:157.75px; left:25px;}
    .qu{margin:0; color:#121212; font-size:25px; font-weight:600; line-height:32px}

    /* 폼 */
    form#periodForm{position:absolute; top:203px; left:25px; width:325px;}
    .row{margin:14px 0}
    .label{display:block; margin:0 0 8px 2px; color:#121212; font-size:14px; font-weight:500}
    .input{
      width:100%; height:56px; padding:12px 14px;
      border-radius:10px; border:1px solid #C3C3C3; background:#FFF; color:#1f1f1f; font-size:16px;
    }
    .select{
      -webkit-appearance:none; appearance:none;
      background:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>") no-repeat right 12px center/20px 20px;
      padding-right:40px;
    }

    /* ✅ 달력 트리거 버튼 (선택 전/후 동일 버튼) */
    .date-trigger{
      width:100%; height:56px; border-radius:10px; border:0; cursor:pointer;
      background:var(--orange-weak); color:#F26430; font-size:16px; font-weight:700;
      display:flex; align-items:center; justify-content:center;
    }
    .date-trigger.picked{
      background:#fff; border:1px solid #C3C3C3; color:#121212; font-weight:600;
      justify-content:flex-start; padding:0 14px;
    }
    .pill-icon{width:20px; height:20px; display:inline-block; margin-right:8px;
      background:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23D9534F' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='4' width='18' height='18' rx='2' ry='2'/><line x1='16' y1='2' x2='16' y2='6'/><line x1='8' y1='2' x2='8' y2='6'/><line x1='3' y1='10' x2='21' y2='10'/><circle cx='8' cy='15' r='1'/><circle cx='12' cy='15' r='1'/><circle cx='16' cy='15' r='1'/></svg>") no-repeat center/contain;
    }

    .radios{display:flex; gap:24px; align-items:center}
    .radio{display:flex; align-items:center; gap:8px; font-size:16px; color:#121212}
    .radio input{appearance:none; width:16px; height:16px; border:2px solid #C3C3C3; border-radius:50%; position:relative; cursor:pointer}
    .radio input:checked{border-color:var(--orange)}
    .radio input:checked::after{content:""; position:absolute; inset:3px; background:var(--orange); border-radius:50%}

    /* 제출버튼 (공통 좌표) */
    .btn-primary{
      width:343px; height:56px; border-radius:10px; border:none; cursor:pointer;
      position:absolute; top:722px; left:16px; font-size:20px; font-weight:700; color:#fff; background:var(--orange);
    }
    .btn-primary:disabled{background:var(--disabled)}

    /* ✅ 바텀시트: app-wrapper 기준 fixed */
    .dim{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      opacity:0; pointer-events:none; transition:.2s; z-index:1000;
    }
    .dim.open{opacity:1; pointer-events:auto;}
    .sheet{
      position:fixed; left:0; right:0; bottom:0; width:100%; max-width:100%;
      background:#fff; border-radius:12px 12px 0 0;
      transform:translateY(110%); transition:.25s; z-index:1001; overflow:hidden;
    }
    .sheet.open{transform:translateY(0)}
    .sheet .handle{width:44px; height:4px; background:#ddd; border-radius:2px; margin:8px auto}
    .sheet .cal-head{display:flex; align-items:center; justify-content:space-between; padding:6px 14px 0}
    .sheet .month-btn{appearance:none; background:none; border:0; font-size:22px; padding:6px 10px; cursor:pointer}
    .sheet .month-title{font-weight:700; font-size:18px}
    .sheet .subtitle{margin:8px 14px; padding:8px 10px; background:#F3F3F3; border-radius:8px; color:#555; font-size:13px; text-align:center}
    .cal-grid{padding:2px 10px 12px}
    .dow{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin:6px 0 2px; color:#888; font-size:12px; text-align:center}
    .days{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; min-height:240px}
    .day{height:36px; display:flex; align-items:center; justify-content:center; border-radius:18px; cursor:pointer; color:#222; font-size:14px}
    .day.muted{color:#bbb; cursor:default}
    .day.selected{background:var(--orange); color:#fff}
    .sheet .done{width:calc(100% - 32px); height:48px; margin:10px 16px 16px; border:none; border-radius:10px; font-weight:700; color:#fff; background:#ccc; cursor:not-allowed}
    .sheet .done.active{background:var(--orange); cursor:pointer}
    .hide-scrollbar::-webkit-scrollbar {
  width: 0; 
  height: 0;
  display: none;
}




  </style>
</head>
<body>
  <div id="root">
    <div id="app-wrapper">

      <!-- 헤더 -->
      <div class="header">
        <button type="button" class="back-btn" aria-label="이전">
          <img src="{% static 'users/images/Vector.png' %}" alt="">
        </button>
        <h1 class="title">방 등록하기</h1>
      </div>

      <!-- 단계/질문 -->
      <p class="num">{{ step|default:"5/9" }}</p>
      <div class="qu-wrapper"><h2 class="qu">입주 가능 날짜</h2></div>

      <!-- 폼 -->
      <form method="post" id="periodForm" novalidate>
        {% csrf_token %}
        <input type="hidden" id="available_date" name="available_date"
               value="{{ form.initial.available_date|date:'Y-m-d' }}">

        <div class="row">
          <!-- ✅ 날짜 버튼은 항상 같은 요소 -->
          <button type="button" id="openCalendar" class="date-trigger">
            달력에서 선택하기
          </button>
        </div>

        <div class="row">
          <label class="label" for="stay_term">거주 희망 기간</label>
          <select name="stay_term" id="stay_term" class="input select">
            {% for v in stay_terms %}
              <option value="{{ v }}" {% if v == initial_stay_term %}selected{% endif %}>{{ v }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="row">
          <label class="label">체험 입주 가능</label>
          <div class="radios">
            <label class="radio"><input type="radio" name="trial_ok" value="예" {% if initial_trial_ok != '아니오' %}checked{% endif %}> 예</label>
            <label class="radio"><input type="radio" name="trial_ok" value="아니오" {% if initial_trial_ok == '아니오' %}checked{% endif %}> 아니오</label>
          </div>
        </div>
      </form>

      <!-- 폼 밖 '다음' 버튼 -->
      <button type="submit" id="nextBtn" class="btn-primary" form="periodForm" disabled>다음</button>

      <!-- ✅ 오버레이/달력 (app-wrapper 기준 fixed) -->
      <div class="dim" id="dim"></div>
      <div class="sheet" id="calendarSheet" aria-hidden="true">
        <div class="handle"></div>
        <div class="cal-head">
          <button class="month-btn" id="prevMonth" aria-label="이전 달">‹</button>
          <div class="month-title" id="monthTitle">2025년 8월</div>
          <button class="month-btn" id="nextMonth" aria-label="다음 달">›</button>
        </div>
        <div class="subtitle">입주 가능한 날짜를 선택해 주세요</div>
        <div class="cal-grid">
          <div class="dow"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
          <div class="days" id="days"></div>
        </div>
        <button class="done" id="calDone" disabled>완료</button>
      </div>

    </div>
  </div>

  <script>
    // 뒤로가기
    document.querySelector('.back-btn').addEventListener('click', ()=>{
      if (history.length > 1) history.back();
      else if (document.referrer) location.href = document.referrer;
      else location.href = '/';
    });

    (function(){
      const hidden = document.getElementById('available_date');
      const openBtn= document.getElementById('openCalendar');
      const next   = document.getElementById('nextBtn');

      const dim    = document.getElementById('dim');
      const sheet  = document.getElementById('calendarSheet');
      const daysEl = document.getElementById('days');
      const title  = document.getElementById('monthTitle');
      const prev   = document.getElementById('prevMonth');
      const nextM  = document.getElementById('nextMonth');
      const done   = document.getElementById('calDone');

      let view = new Date(); view.setDate(1);
      let picked = null;

      function fmtK(d){
        const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
        return `${y}년 ${String(m).padStart(2,'0')}월 ${String(day).padStart(2,'0')}일부터`;
      }
      function fmtVal(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

      function renderBtn(){
        // 버튼의 내용/스타일만 교체, 클릭 이벤트는 유지
        if (picked){
          openBtn.classList.add('picked');
          openBtn.innerHTML = `<span class="pill-icon" aria-hidden="true"></span><span>${fmtK(picked)}</span>`;
          next.disabled = false;
        }else{
          openBtn.classList.remove('picked');
          openBtn.textContent = '달력에서 선택하기';
          next.disabled = true;
        }
      }

      function setPicked(d){
        picked = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        done.disabled = false; done.classList.add('active');
        renderCalendar(); // 선택 표시 반영
      }

      function renderCalendar(){
        title.textContent = `${view.getFullYear()}년 ${String(view.getMonth()+1).padStart(2,'0')}월`;
        daysEl.innerHTML = '';
        const year=view.getFullYear(), month=view.getMonth();
        const startDow = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month+1, 0).getDate();
        const prevLast = new Date(year, month, 0).getDate();

        for(let i=startDow-1;i>=0;i--){
          const el=document.createElement('div'); el.className='day muted'; el.textContent=(prevLast-i); daysEl.appendChild(el);
        }
        for(let d=1; d<=lastDate; d++){
          const el=document.createElement('div'); el.className='day'; el.textContent=d;
          const dt=new Date(year, month, d);
          if (picked && dt.toDateString()===picked.toDateString()) el.classList.add('selected');
          el.addEventListener('click', ()=> setPicked(dt));
          daysEl.appendChild(el);
        }
        const filled = daysEl.children.length;
        for(let d=1; d<=42-filled; d++){
          const el=document.createElement('div'); el.className='day muted'; el.textContent=d; daysEl.appendChild(el);
        }
      }

      function openSheet(){ dim.classList.add('open'); sheet.classList.add('open'); }
      function closeSheet(){ dim.classList.remove('open'); sheet.classList.remove('open'); }

      // 초기값 반영
      (function init(){
        const v = hidden.value;
        if (v){
          const [y,m,d] = v.split('-').map(Number);
          picked = new Date(y, m-1, d);
        }
        renderBtn();
        renderCalendar();
      })();

      // 트리거: 언제나 같은 버튼이 달력을 연다
      openBtn.addEventListener('click', openSheet);
      dim.addEventListener('click', closeSheet);
      prev.addEventListener('click', ()=>{ view.setMonth(view.getMonth()-1); renderCalendar(); });
      nextM.addEventListener('click', ()=>{ view.setMonth(view.getMonth()+1); renderCalendar(); });

      // 완료 → 값 저장 + 버튼 텍스트/스타일 변경 + 닫기
      done.addEventListener('click', function(){
        if (!picked) return;
        hidden.value = fmtVal(picked);
        renderBtn();
        closeSheet();
      });
    })();
  </script>
</body>
</html>
