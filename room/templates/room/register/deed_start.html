<h1>방 등록하기</h1>

{% if error %}
  <div style="color:#c00; margin-bottom:8px;">{{ error }}</div>
{% endif %}

<form id="deedForm" method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- 업로드 출처 -->
  <input type="hidden" name="source" id="sourceField" value="">

  <!-- 실제 파일 입력 (시각적 숨김) -->
  <!-- 카메라 전용: 모바일에서 카메라 우선 -->
  <input
    type="file"
    id="deedCamera"
    name="file"
    accept="image/*"
    capture="environment"
    class="visually-hidden"
  >
  <!-- 파일 첨부: 갤러리/파일앱/PDF/HEIC 허용 -->
  <input
    type="file"
    id="deedFile"
    name="file"
    accept="image/*,image/heic,image/heif,application/pdf,.pdf,.heic,.heif"
    class="visually-hidden"
  >

  <!-- 사용자 버튼 -->
  <div style="display:flex; gap:12px;">
    <label for="deedCamera" class="btn">카메라로 촬영</label>
    <label for="deedFile" class="btn">파일 첨부</label>
  </div>

  <!-- 선택한 파일명 표시(선택) -->
  <p id="pickedName" class="small" style="margin-top:10px;"></p>
</form>

<style>
  .visually-hidden {
    position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;
  }
  .btn { display:inline-block; padding:12px 16px; border:1px solid #ddd; border-radius:10px; cursor:pointer; }
  .btn:hover { background:#f7f7f7; }
  .small { color:#666; font-size:12px; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('deedForm');
    const cameraInput = document.getElementById('deedCamera');
    const fileInput = document.getElementById('deedFile');
    const srcField = document.getElementById('sourceField');
    const pickedName = document.getElementById('pickedName');

    function onPicked(e) {
      const input = e.target;
      if (!input.files || !input.files.length) return;

      // 파일명 표시
      if (pickedName) pickedName.textContent = input.files[0].name || '';

      // 소스 구분값 세팅 (camera/file)
      srcField.value = (input === cameraInput) ? 'camera' : 'file';

      // 즉시 업로드 (POST) → 서버에서 temp 저장 후 deed_preview로 redirect
      form.submit();
    }

    // change 시점(선택 완료)에서 처리하는 게 가장 안정적
    cameraInput.addEventListener('change', onPicked);
    fileInput.addEventListener('change', onPicked);
  });
</script>
