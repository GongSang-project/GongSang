<h1>등기부등본 확인</h1>

{% if is_image %}
  <img id="deedImg" src="{{ file_url }}" alt="" style="max-width:100%;height:auto" onerror="fallbackToLink()">
  <div id="fileLink" style="display:none;margin-top:8px;">
    <a href="{{ file_url }}" target="_blank" rel="noopener">파일로 열기</a>
  </div>
{% else %}
  <p>업로드된 파일: <strong>{{ file_name }}</strong></p>
  <a href="{{ file_url }}" target="_blank" rel="noopener">파일 열기</a>
{% endif %}

<!-- 재업로드 바로 처리 (뒤로가기 없음) -->
<form id="reuploadForm" method="post" action="{% url 'room:deed_start' %}" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="source" id="reSrc" value="">

  <!-- 카메라(다시 촬영)용 파일 인풋 -->
  <input type="file" id="reCam" name="file" accept="image/*" capture="environment" class="visually-hidden">

  <!-- 파일(다시 첨부)용 파일 인풋: 이미지+PDF+HEIC 지원 -->
  <input type="file" id="reFile" name="file"
         accept="image/*,image/heic,image/heif,application/pdf,.pdf,.heic,.heif"
         class="visually-hidden">
</form>

<div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
  {% if source == "camera" %}
    <!-- ✅ 라벨-포 방식: OS 파일 선택창이 바로 뜬다 -->
    <label for="reCam" class="btn">다시 촬영</label>
  {% else %}
    <label for="reFile" class="btn">다시 첨부</label>
  {% endif %}

  <!-- 확인은 POST로 안전하게 -->
  <form method="post" action="{% url 'room:deed_confirm' %}" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-primary">확인</button>
  </form>
</div>

<style>
  .visually-hidden { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
  .btn{display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:10px;cursor:pointer;background:#fff;text-decoration:none;color:#222}
  .btn:hover{background:#f7f7f7}
  .btn-primary{border-color:#0a66ff}
  .btn-primary:hover{background:#e8f0ff}
</style>

<script>
  function fallbackToLink(){
    var img = document.getElementById('deedImg');
    var link = document.getElementById('fileLink');
    if(img && link){ img.style.display='none'; link.style.display='block'; }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('reuploadForm');
    const src  = document.getElementById('reSrc');
    const cam  = document.getElementById('reCam');
    const fil  = document.getElementById('reFile');

    // 선택이 끝나면 즉시 업로드 → deed_start(POST) → temp 교체 → 다시 미리보기
    cam.addEventListener('change', function(){
      if (!cam.files.length) return;
      src.value = 'camera';
      form.submit();
    });
    fil.addEventListener('change', function(){
      if (!fil.files.length) return;
      src.value = 'file';
      form.submit();
    });
  });
</script>
