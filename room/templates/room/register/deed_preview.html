{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>등기부등본 확인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="{% static 'review/css/write_review.css' %}">
  <style>
    .visually-hidden { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

    /* 폰트 */
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

    /* --- Reset & Globals --- */
    * { box-sizing: border-box; }
    body { margin:0; background:#000; padding:30px 0 60px; font-family:'Pretendard',system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif; }
    #root { width:375px; height:812px; margin:0 auto; overflow:hidden; position:relative; background:#fff; }
    #app-wrapper { width:100%; height:100%; position:relative; overflow:auto; }

    /* 헤더(스코프 고정) */
    .header { position:sticky; top:0; height:102.94px; background:#fff; z-index:1000; }
    .header .back-btn { appearance:none; background:none; border:0; cursor:pointer; position:absolute; left:20.6133px; z-index:1010; }
    .header .icon { width:20px; height:27px; padding:6px; }
    .header .title { color:#121212; text-align:center; font-size:20px; font-weight:500; line-height:15px; letter-spacing:-0.1px; margin:0; position:absolute; top:60px; left:50%; transform:translateX(-50%); white-space:nowrap; }

    /* 공통 질문/설명 블록 */
    .qu-wrapper { display:flex; flex-direction:column; gap:25px; position:absolute; top:157.75px; left:25px; }
    .qu { color:#121212; font-size:25px; font-weight:600; line-height:15px; letter-spacing:-0.125px; margin:0; }
    .qu span { display:block; }
    .qu span + span { margin-top:21px; }
    .explanation { color:#121212; font-size:20px; font-weight:500; line-height:15px; letter-spacing:-0.1px; margin:0; }
    .explanation span { display:block; }
    .explanation span + span { margin-top:11px; }

    /* 단계 숫자 */
    .num { position:absolute; top:126.75px; left:24px; color:#515151; font-size:15px; font-weight:500; letter-spacing:-0.075px; margin:0; }

    /* 개인정보 안내 */
    .privacy-note { color:#515151; font-size:16px; font-weight:500; line-height:15px; letter-spacing:-0.08px; margin:0; position:absolute; top:619px; left:85px; }

    /* 버튼들 */
    .btns { display:flex; flex-direction:column; gap:16px; position:absolute; top:650px; left:16px; z-index:2; }
    .btn-camera, .btn-gallery { width:343px; height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center; text-align:center; text-decoration:none; font-size:20px; font-weight:700; line-height:22px; border:0; }
    .btn-camera { color:#F26430; background:#FFEBD9; }
    .btn-gallery { background:#F26430; color:#fff; }

    /* 확인 CTA (다음단계) — 미사용 시 제거 가능 */
    .cta { width:343px; height:56px; border-radius:10px; border:none; font-size:20px; font-weight:700; color:#fff; background:#F26430; cursor:pointer; position:absolute; top:722px; left:16px; }
    .cta:disabled { background:#959595; }

    /* 아이콘(미리보기 페이지에선 계약서 아이콘만 사용 가능) */
    .contract_icon { width:190.6884px; height:209.7114px; position:absolute; top:309px; left:93px; }
    .home_icon { width:142.712px; height:118.031px; position:absolute; top:386px; left:142px; }
    .hand_icon { width:189px; height:189px; position:absolute; top:397.3149px; left:88px; }

    /* 미리보기 박스 */
    .review-photo {
      display:inline-flex; height:396px; width:297px; flex-direction:column; justify-content:center; align-items:center;
      background:#F3F3F3; position:absolute; top:231.375px; left:39.5px; overflow:hidden; border-radius:8px;
    }
    .review-photo img { max-width:100%; max-height:100%; object-fit:contain; display:block; }
    .review-photo .ph { position:absolute; color:#999; font-size:14px; pointer-events:none; }
    .file-link { margin-top:8px; font-size:14px; }

    /* 파일명 표시(선택사항) */
    #pickedName { position:absolute; top:615px; left:16px; width:343px; font-size:14px; color:#515151; text-align:center; }
  </style>
</head>
<body>
  <div id="root">
    <div id="app-wrapper">

      <!-- 헤더 -->
      <div class="header">
        <button type="button" class="back-btn" aria-label="이전">
          <img src="{% static 'users/images/Vector.png' %}" alt="" class="icon">
        </button>
        <h1 class="title">방 등록하기</h1>
      </div>

      <!-- 현재 단계 -->
      <p class="num">1/9</p>

      <!-- 질문 -->
      <div class="qu-wrapper">
        <h2 class="qu"><span>등기부등본을</span><span>확인해주세요.</span></h2>
      </div>

      <!-- 미리보기 -->
      <div class="review-photo">
        {% if is_image %}
          <img id="deedImg" src="{{ file_url }}" alt="계약서 사진" onerror="fallbackToLink()">
          <div id="fileLink" class="file-link" style="display:none;">
            <a href="{{ file_url }}" target="_blank" rel="noopener">파일로 열기</a>
          </div>
        {% else %}
          <p class="ph">업로드된 파일: <strong>{{ file_name }}</strong></p>
          <a class="file-link" href="{{ file_url }}" target="_blank" rel="noopener">파일 열기</a>
        {% endif %}
      </div>

      <!-- 버튼들 -->
      <div class="btns">
        <!-- 첫 번째 버튼: 다시 촬영/다시 첨부 (소스에 따라 텍스트/동작 변경) -->
        <button type="button" class="btn-camera" id="btnAgain">다시 촬영</button>
        <!-- 두 번째 버튼: 확인 → deed_confirm POST -->
        <button type="button" class="btn-gallery" id="btnConfirm">확인</button>
      </div>

      <!-- (선택) 파일명 표시 -->
      <p id="pickedName"></p>

      <!-- 재업로드 폼: 선택하면 즉시 POST로 temp 교체 -->
      <form id="reuploadForm" method="post" action="{% url 'room:deed_start' %}" enctype="multipart/form-data" class="visually-hidden">
        {% csrf_token %}
        <input type="hidden" name="source" id="reSrc" value="">
        <input type="file" id="reCam"  name="file" accept="image/*" capture="environment">
        <input type="file" id="reFile" name="file" accept="image/*,image/heic,image/heif,application/pdf,.pdf,.heic,.heif">
      </form>

      <!-- 확인 폼: 안전하게 POST -->
      <form id="confirmForm" method="post" action="{% url 'room:deed_confirm' %}" class="visually-hidden">
        {% csrf_token %}
      </form>

    </div>
  </div>

  <script>
    // 이미지 로드 실패 시 링크로 대체
    function fallbackToLink(){
      var img = document.getElementById('deedImg');
      var link = document.getElementById('fileLink');
      if(img && link){ img.style.display='none'; link.style.display='block'; }
    }

    document.addEventListener('DOMContentLoaded', function(){
      // 백 버튼
      document.querySelector('.back-btn').addEventListener('click', function () {
        if (window.history.length > 1) {
          window.history.back();
        } else if (document.referrer) {
          location.href = document.referrer;
        } else {
          location.href = '/';
        }
      });

      const SOURCE = "{{ source|default:'' }}";   // 'camera' 또는 'file'
      const againBtn   = document.getElementById('btnAgain');
      const confirmBtn = document.getElementById('btnConfirm');
      const pickedName = document.getElementById('pickedName');

      const reForm = document.getElementById('reuploadForm');
      const reSrc  = document.getElementById('reSrc');
      const reCam  = document.getElementById('reCam');
      const reFile = document.getElementById('reFile');

      // 버튼 라벨 동적 변경
      if (SOURCE === 'file') {
        againBtn.textContent = '다시 첨부';
      } else {
        againBtn.textContent = '다시 촬영';
      }

      // 첫 번째 버튼 클릭 → 해당 입력창 열기
      againBtn.addEventListener('click', function(){
        if (SOURCE === 'file') {
          reFile.click();
        } else {
          reCam.click();
        }
      });

      // 파일 선택 완료 시 즉시 POST 제출 → temp 교체 → 이 페이지로 리다이렉트
      function onPicked(input, srcValue){
        if (!input.files || !input.files.length) return;
        if (pickedName) pickedName.textContent = input.files[0].name || '';
        reSrc.value = srcValue;
        reForm.submit();
      }
      reCam.addEventListener('change', function(){ onPicked(reCam, 'camera'); });
      reFile.addEventListener('change', function(){ onPicked(reFile, 'file'); });

      // 확인 버튼 → deed_confirm POST
      confirmBtn.addEventListener('click', function(){
        document.getElementById('confirmForm').submit();
      });
    });
  </script>
</body>
</html>
