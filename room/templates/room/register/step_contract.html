{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>방 등록 - 4. 거래 정보</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="{% static 'users/css/survey_form.css' %}">
  <style>
    /* 폰트 */
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

    :root{
      --orange:#F26430;
      --black:#121212;
      --disabled:#959595;
      --page-w:375px;
    }

    *{box-sizing:border-box}
    body{margin:0;background:#000;font-family:'Pretendard',system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
    #root{width:var(--page-w);height:812px;margin:0 auto;background:#fff;position:relative;overflow:hidden}
    #app-wrapper{width:100%;height:100%;overflow:auto;position:relative}

    /* 헤더 (공통) */
    .header{position:sticky;top:0;height:102.94px;background:#fff;z-index:100}
    .back-btn{appearance:none;background:none;border:0;cursor:pointer;position:absolute;left:20.6133px;top:54px}
    .back-btn img{width:20px;height:27px;padding:6px}
    .title{position:absolute;top:60px;left:143px;margin:0;color:var(--black);font-size:20px;font-weight:500;line-height:15px;white-space:nowrap}

    /* 단계 번호 / 질문 (공통 좌표) */
    .num{
      position:absolute; top:126.75px; left:24px; margin:0;
      color:#515151; font-size:15px; font-weight:500; letter-spacing:-.075px;
    }
    .qu-wrapper{
      display:flex; flex-direction:column; gap:25px;
      position:absolute; top:157.75px; left:25px;
    }
    .qu{
      margin:0; color:#121212; font-size:25px; font-weight:600; line-height:32px; letter-spacing:-.2px;
    }

    /* 폼 레이아웃 (공통 좌표) */
    form#contractForm{
      position:absolute; top:203px; left:25px; width:325px;
    }
    .row{margin:14px 0}
    .row label{display:block; margin:0 0 8px 2px; color:#121212; font-size:14px; font-weight:500}

    /* 입력 공통 */
    .input{
      width:100%; height:56px; padding:12px 14px;
      border-radius:10px; border:1px solid #C3C3C3; background:#FFF;
      color:#1f1f1f; font-size:16px; outline:none;
    }
    .input:focus{box-shadow:0 0 0 2px rgba(242,100,48,.15)}

    /* select에 다운캐럿 */
    .select{
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>")
        no-repeat right 12px center / 20px 20px;
      padding-right:40px;
    }

    /* 금액 입력 줄 */
    .money-line{display:flex; align-items:center; gap:8px}
    .unit{color:#666; margin-left:8px}

    /* 제출 버튼 (공통 좌표) */
    .btn-primary{
      width:343px; height:56px; border-radius:10px; border:none; cursor:pointer;
      position:absolute; top:722px; left:16px;
      font-size:20px; font-weight:700; color:#fff; background:var(--orange);
    }
    .btn-primary:disabled{background:var(--disabled)}
  </style>
</head>
<body>
  <div id="root">
    <div id="app-wrapper">

      <!-- 헤더 -->
      <div class="header">
        <button type="button" class="back-btn" aria-label="이전">
          <img src="{% static 'users/images/Vector.png' %}" alt="">
        </button>
        <h1 class="title">방 등록하기</h1>
      </div>

      <!-- 단계 / 질문 -->
      <p class="num">{{ step|default:"4/9" }}</p>
      <div class="qu-wrapper">
        <h2 class="qu">계약 형태를 선택해주세요</h2>
      </div>

      {% if form.errors %}
        <div style="position:absolute; top:190px; left:25px; width:325px; background:#ffe8e8;border:1px solid #ffb4b4;padding:10px;border-radius:10px;color:#b10000;">
          입력을 확인해 주세요.
        </div>
      {% endif %}

      <!-- 폼 -->
      <form method="post" id="contractForm" novalidate>
        {% csrf_token %}

        <!-- 계약 형태 -->
        <div class="row">
          <label for="contract_type">계약 형태</label>
          <select name="contract_type" id="contract_type" class="input select">
            {% for v in contract_types %}
              <option value="{{ v }}" {% if v == initial_contract_type %}selected{% endif %}>{{ v }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 월세/사용료 -->
        <div class="row">
          <label for="rent_fee"><span id="rent_label">월세/사용료</span></label>
          <div class="money-line">
            <input type="number" name="rent_fee" id="rent_fee" min="0" step="1" required
                   value="{{ form.initial.rent_fee|default:'' }}" placeholder="예: 25" class="input" style="flex:1">
            <span class="unit">만원</span>
          </div>
        </div>

        <!-- 관리비 -->
        <div class="row">
          <label for="utility_fee">관리비</label>
          <div class="money-line">
            <input type="number" name="utility_fee" id="utility_fee" min="0" step="1"
                   value="{{ form.initial.utility_fee|default:'' }}" placeholder="예: 2" class="input" style="flex:1">
            <span class="unit">만원</span>
          </div>
        </div>

        <!-- 보증금 -->
        <div class="row">
          <label for="deposit">보증금</label>
          <div class="money-line">
            <input type="number" name="deposit" id="deposit" min="0" step="1" required
                   value="{{ form.initial.deposit|default:'' }}" placeholder="예: 200" class="input" style="flex:1">
            <span class="unit">만원</span>
          </div>
        </div>
      </form>

      <!-- 폼 바깥 버튼 (고정 좌표) -->
      <button type="submit" id="nextBtn" class="btn-primary" form="contractForm" disabled>다음</button>

    </div>
  </div>

  <script>
    // 뒤로가기(공통)
    document.querySelector('.back-btn').addEventListener('click', ()=>{
      if (history.length > 1) history.back();
      else if (document.referrer) location.href = document.referrer;
      else location.href = '/';
    });

    (function () {
      const sel   = document.getElementById('contract_type');
      const rentL = document.getElementById('rent_label');
      const rent  = document.getElementById('rent_fee');
      const depo  = document.getElementById('deposit');
      const btn   = document.getElementById('nextBtn');
      const form  = document.getElementById('contractForm');

      // 라벨 동기화
      function syncLabel(){
        rentL.textContent = (sel.value === '단기거주') ? '사용료' : '월세';
      }
      sel.addEventListener('change', syncLabel);
      syncLabel();

      // 버튼 활성화: 필수값(월세/사용료, 보증금) > 0
      function toggle(){
        const ok = Number(rent.value) >= 0 && rent.value !== '' &&
                   Number(depo.value) >= 0 && depo.value !== '';
        btn.disabled = !ok;
      }
      rent.addEventListener('input', toggle);
      depo.addEventListener('input', toggle);
      toggle();

      // 구형 브라우저 대비 안전 제출
      btn.addEventListener('click', function(e){
        if (btn.disabled) { e.preventDefault(); return; }
        if (form.reportValidity && !form.reportValidity()) { e.preventDefault(); return; }
        if (form.requestSubmit) form.requestSubmit(); else { e.preventDefault(); form.submit(); }
      });
    })();
  </script>
</body>
</html>
