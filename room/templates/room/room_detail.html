<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>방 상세 페이지 (테스트용)</title>
</head>
<body>
    <h1>방 상세 정보</h1>
    <p>방 ID: {{ room.id }}</p>
    <p>방 소유주 (시니어) ID: {{ room.owner.id }}</p>
    <p>월세: {{ room.rent_fee }}</p>
    <p>보증금: {{ room.deposit }}</p>

    {% if matching_score is not None %}
        <p>나와의 매칭 점수: <strong>{{ matching_score }}점</strong></p>
    {% else %}
        <p>로그인 후 매칭 점수를 확인하세요.</p>
    {% endif %}

    {% if ai_recommendation_reason %}
        <p><strong>AI 추천 이유:</strong></p>
        <p>
            {% if ai_recommendation_reason|length > 60 %}
                {{ ai_recommendation_reason|slice:":60" }}...
            {% else %}
                {{ ai_recommendation_reason }}
            {% endif %}
        </p>
    {% endif %}

    <a href="{% url 'users:senior_profile' senior_id=room.owner.id room_id=room.id %}">
        시니어 프로필 보기
    </a>

    {% if request.user.is_authenticated and request.user.is_youth %}
        {% if is_requested_before %}
            <button id="requestButton" data-room-id="{{ room.id }}" disabled>입주 요청을 보냈습니다</button>
        {% else %}
            <button id="request-button" data-room-id="{{ room.id }}">입주 희망 요청하기</button>
        {% endif %}
        <p id="requestStatus" style="color: green;"></p>
    {% else %}
    <p>로그인 후 입주 희망 요청을 할 수 있습니다.</p>
    {% endif %}



    <!--입주 희망 요청 버튼 구현을 위해 필요한 임시 js입니다-->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const requestButton = document.getElementById('request-button');
        const requestedButton = document.getElementById('requestButton');
        const buttonToUse = requestButton || requestedButton;

        if (!buttonToUse) return;

        const roomId = buttonToUse.dataset.roomId;
        const csrfToken = '{{ csrf_token }}';

        if (requestButton) { // '입주 희망 요청하기' 버튼이 존재할 때만 이벤트 리스너 추가
            requestButton.addEventListener('click', function() {
                // 요청을 보내기만 하고, 서버 응답을 처리하지 않음
                fetch(`{% url 'matching:request_move_in' 0 %}`.replace('0', roomId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    // 요청이 성공적으로 완료되면 (302 리디렉션 응답을 받으면)
                    if (response.redirected) {
                        window.location.reload(); // 페이지를 새로고침하여 Django 뷰를 다시 실행
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('requestStatus').textContent = '네트워크 오류가 발생했습니다.';
                });

                // 사용자에게 즉각적인 피드백 제공
                requestButton.textContent = '요청 처리 중...';
                requestButton.disabled = true;
            });
        }
    });
    </script>

    <div class="reviews-section">
        <h4>후기 ★<i class="fa-solid fa-star"></i> {{ average_rating|floatformat:"1" }} ({{ review_count }}개)</h4>
        <div class="review-summary">
            <h5>AI 후기 요약 분석 <i class="fa-solid fa-robot"></i></h5>
            <p>{{ ai_summary }}</p>
        </div>

        <div class="review-hashtags">
            <div class="review-hashtags-item">
                <p>개선되었으면 좋았을 점</p>
                <div class="hashtags">
                    {% for tag in bad_hashtags %}
                        <span>{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            <div class="review-hashtags-item">
                <p>좋았던 점</p>
                <div class="hashtags">
                    {% for tag in good_hashtags %}
                        <span>{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="individual-reviews">
            {% for review in reviews|slice:":2" %}
            <div class="review-item">
                <div class="review-meta">
                    <p class="reviewer-name">
                        {% if review.is_anonymous %}
                            익명{{ forloop.counter }}
                        {% else %}
                            {{ review.author.username }}
                        {% endif %}
                    </p>
                    <p class="residence-period">{{ review.get_lived_period_display }}</p>
                </div>
                <div class="review-rating">
                    <span class="star-rating">
                        {% if review.satisfaction == 'VERY_SATISFIED' %}★★★★★
                        {% elif review.satisfaction == 'SATISFIED' %}★★★★☆
                        {% elif review.satisfaction == 'NORMAL' %}★★★☆☆
                        {% elif review.satisfaction == 'DISSATISFIED' %}★★☆☆☆
                        {% else %}★☆☆☆☆
                        {% endif %}
                    </span>
                    <span class="review-date">{{ review.created_at|date:"Y년 m월 d일" }} 작성</span>
                </div>
                <p class="review-text">{{ review.good_points }}</p>
            </div>
            {% empty %}
            <p>아직 등록된 후기가 없습니다.</p>
            {% endfor %}
        </div>

        {% if review_count > 0 %}
        <div class="view-all-reviews">
            <a href="{% url 'room:all_reviews_for_room' room.id %}">
                <button>후기 모두 보기</button>
            </a>
        </div>
        {% endif %}
    </div>
</body>
</html>