<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ display_region }} 방 검색 결과</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --sheet-radius:16px; --btn:#f0643b; --chip:#f27d5b18;
      --card:#fff; --border:#e8eaee; --muted:#6b7280; --text:#111827;
      --accent:#f0643b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;color:var(--text)}
    .container{max-width:960px;margin:20px auto;padding:0 12px}

    /* ===== Topbar ===== */
    .topbar-wrap{
      position:sticky;top:0;z-index:30;background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.04);
    }
    .topbar{
      max-width:960px;margin:0 auto;padding:14px 16px 10px;
      display:flex;align-items:center;gap:10px;
    }
    .backbtn2{
      width:28px;height:28px;border:0;background:transparent;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .backbtn2 svg{width:22px;height:22px;fill:#6b7280}
    .title-line{
      display:flex;align-items:baseline;gap:8px;
      font-weight:800;font-size:20px;color:var(--text);
    }
    .title-line small{color:#9ca3af;font-weight:700;font-size:16px}

    /* 상단 필터 바 */
    .filterbar{background:#fff;border-top:1px solid #f2f2f4;box-shadow:0 6px 16px rgba(0,0,0,.04);}
    .filterbar-inner{max-width:960px;margin:0 auto;padding:10px 16px;}

    /* 상단 라벨/툴바 */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:0}
    .toolbtn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border:1px solid #e7e7e7;border-radius:12px;background:#fff;cursor:pointer}
    .toolbtn .value{color:#111;font-weight:600}
    .toolbtn small{color:#666}
    .applybar{display:flex;gap:10px}
    .applybar .reset{background:#fff;border:1px solid #eee}
    .applybar .ok{background:var(--btn);color:#fff;border:none}

    /* ===== 리스트 카드 (모바일앱 느낌) ===== */
    .list{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .card{position:relative;display:grid;grid-template-columns:120px 1fr;gap:14px;
          padding:12px;border:1px solid var(--border);border-radius:14px;background:var(--card)}
    .thumb{position:relative;width:120px;height:120px;border-radius:12px;overflow:hidden;background:#eee}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .heart{position:absolute;right:8px;top:8px;width:30px;height:30px;border-radius:999px;
           display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.95);
           border:1px solid var(--border);font-size:16px}
    .dots{position:absolute;left:50%;transform:translateX(-50%);bottom:6px;display:flex;gap:4px}
    .dot{width:6px;height:6px;border-radius:999px;background:#fff9;border:1px solid #fff}
    .title{font-weight:800;font-size:20px;margin:0 0 6px}
    .meta{color:var(--muted);line-height:1.4}
    .row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .badge{display:inline-block;background:#e8f1ff;border:1px solid #cfe1ff;color:#2563eb;
           padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:6px}
    .pill .em{font-weight:800}
    .link{position:absolute;inset:0;border-radius:14px;/* for tap area */}
    @media(min-width:760px){
      .card{grid-template-columns:160px 1fr}
      .thumb{width:160px;height:120px}
    }

    /* ===== bottom sheet ===== */
    .sheet-backdrop{position:fixed;inset:0;background:#0006;opacity:0;visibility:hidden;transition:.2s;z-index:20}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -8px 30px #0002;transition:.3s;z-index:21}
    .sheet.open{bottom:0}
    .sheet-head{padding:14px 18px 6px;border-bottom:1px solid #f1f1f1}
    .sheet-title{margin:0;font-size:16px;font-weight:700}
    .sheet-body{padding:14px 18px 18px;display:grid;gap:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:10px;border:1px solid #eee;background:var(--chip);cursor:pointer}
    .chip.active{border-color:var(--btn);background:#ffece7}
    .section label{display:block;margin-bottom:6px;font-weight:600}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .sheet-foot{padding:12px 18px 18px;border-top:1px solid #f4f4f4;display:flex;gap:10px}
    .sheet-foot button{flex:1;padding:12px;border-radius:12px;border:1px solid #eee;cursor:pointer;font-weight:600}
    .date-row{display:flex;gap:10px}
    .date-row input{flex:1;padding:10px;border:1px solid #eee;border-radius:10px}
  </style>

</head>
<body>
<!-- ===== 상단 Topbar + 필터 chips ===== -->
<div class="topbar-wrap">
  <div class="topbar">
    <!-- 뒤로가기 -->
    <button class="backbtn2" type="button" aria-label="뒤로가기" onclick="history.back()">
      <!-- chevron-left -->
      <svg viewBox="0 0 24 24" width="22" height="22">
        <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
      </svg>
    </button>

    <!-- 제목 / 개수 -->
    <div class="title-line">
      <span>{{ display_region }}</span>
      <small>| 전체 {{ total }}개</small>
    </div>
  </div>

  <!-- 필터 chips (폼 안에서 값 유지) -->
  <div class="filterbar">
    <div class="filterbar-inner">
      <form method="get" id="roomFilterForm" style="margin:0">
        <!-- 숨김 파라미터 유지 -->
        <input type="hidden" name="q" value="{{ request.GET.q }}">
        <input type="hidden" name="region" value="{{ request.GET.region }}">
        <input type="hidden" name="property_type" id="property_type" value="{{ request.GET.property_type }}">
        <input type="hidden" name="deal_types" id="deal_types" value="{{ request.GET.deal_types }}">
        <input type="hidden" name="deposit_min" id="deposit_min" value="{{ request.GET.deposit_min }}">
        <input type="hidden" name="deposit_max" id="deposit_max" value="{{ request.GET.deposit_max }}">
        <input type="hidden" name="rent_min" id="rent_min" value="{{ request.GET.rent_min }}">
        <input type="hidden" name="rent_max" id="rent_max" value="{{ request.GET.rent_max }}">
        <input type="hidden" name="move_in_from" id="move_in_from" value="{{ request.GET.move_in_from }}">

        <div class="toolbar">
          <button type="button" class="toolbtn" id="btnType">
            <span class="value" id="labelType">
              {% if request.GET.property_type %}{{ request.GET.property_type }}{% else %}매물유형{% endif %}
            </span>
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z" fill="#9ca3af"/></svg>
          </button>

          <button type="button" class="toolbtn" id="btnDeal">
            <span class="value" id="labelDeal">
              {% if request.GET.deal_types %}
                {{ request.GET.deal_types }}{% if request.GET.rent_min or request.GET.rent_max %} · 월세 {{ request.GET.rent_min|default:"-" }}~{{ request.GET.rent_max|default:"-" }}{% endif %}
              {% else %}거래유형/가격{% endif %}
            </span>
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z" fill="#9ca3af"/></svg>
          </button>

          <button type="button" class="toolbtn" id="btnDate">
            <span class="value" id="labelDate">
              {% if request.GET.move_in_from %}{{ request.GET.move_in_from }}{% else %}입주 날짜{% endif %}
            </span>
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z" fill="#9ca3af"/></svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
  </form>

  {# ========== 목록 ========== #}
  <div class="list">
    {% for r in page_obj %}
      <article class="card">
        <div class="thumb">
          {% with photos=r.room_photos.all %}
            {% if photos|length %}
              <img src="{{ photos.0.image.url }}" alt="">
              <button class="heart" type="button" aria-label="찜하기">♡</button>
              <div class="dots">
                {% for _ in photos|slice:":5" %}<span class="dot"></span>{% endfor %}
              </div>
            {% else %}
              <img src="https://via.placeholder.com/400x300?text=Room" alt="">
            {% endif %}
          {% endwith %}
        </div>

        <div>
          <h3 class="title">월세 {{ r.deposit|floatformat:0 }}/{{ r.rent_fee|floatformat:0 }}</h3>
          <div class="meta" style="margin-bottom:6px">
            {{ r.address_city }} {{ r.address_district }}
          </div>
          <div class="meta">
            {% if r.get_property_type_display %}{{ r.get_property_type_display }}{% endif %}
            {% if r.floor %} {{ r.floor }}층{% endif %}{% if r.floor and r.area %}, {% endif %}
            {% if r.area %}방 {{ r.area|floatformat:1 }}m²{% endif %}
          </div>

          <div class="row">
            <span class="meta">👵👴 시니어 {% if r.owner.is_senior_couple %}부부{% else %}가구{% endif %}</span>
            {% if r.can_short_term %}
              <span class="badge">체험 입주 가능</span>
            {% endif %}
          </div>
        </div>

        <a class="link" href="{% url 'room:room_detail' r.id %}" aria-label="상세보기"></a>
      </article>
    {% empty %}
      <p style="color:var(--muted);margin:20px 4px">조건에 맞는 방이 없습니다.</p>
    {% endfor %}
  </div>

  <div style="display:flex;align-items:center;gap:8px;justify-content:center;margin:14px 0">
    {% if page_obj.has_previous %}<a href="?{{ prev_qs }}" style="text-decoration:none;border:1px solid var(--border);padding:8px 12px;border-radius:10px">이전</a>{% endif %}
    <span class="meta">페이지 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}<a href="?{{ next_qs }}" style="text-decoration:none;border:1px solid var(--border);padding:8px 12px;border-radius:10px">다음</a>{% endif %}
  </div>
</div>

<!-- ===== 시트들 (기존 JS 그대로 동작) ===== -->
<div class="sheet-backdrop" id="backdropType" hidden></div>
<div class="sheet" id="sheetType" aria-hidden="true">
  <div class="sheet-head"><h3 class="sheet-title">매물 유형</h3></div>
  <div class="sheet-body">
    <div class="chips" id="typeChips">
      <span class="chip" data-value="">전체</span>
      <span class="chip" data-value="아파트">아파트</span>
      <span class="chip" data-value="빌라">빌라</span>
      <span class="chip" data-value="오피스텔">오피스텔</span>
      <span class="chip" data-value="주택">주택</span>
    </div>
  </div>
  <div class="sheet-foot">
    <button type="button" class="reset" data-reset-type>초기화</button>
    <button type="button" class="ok" data-apply-type>확인</button>
  </div>
</div>

<div class="sheet-backdrop" id="backdropDeal" hidden></div>
<div class="sheet" id="sheetDeal" aria-hidden="true">
  <div class="sheet-head"><h3 class="sheet-title">거래 방식 · 가격</h3></div>
  <div class="sheet-body">
    <div class="section">
      <label>거래 방식 (중복 선택 가능)</label>
      <div class="chips" id="dealChips">
        <span class="chip" data-value="체험입주">체험 입주</span>
        <span class="chip" data-value="월세">월세</span>
      </div>
    </div>
    <div class="section">
      <label>보증금 (만원)</label>
      <div class="row2">
        <input type="number" id="inpDepositMin" placeholder="최소">
        <input type="number" id="inpDepositMax" placeholder="최대">
      </div>
    </div>
    <div class="section">
      <label>월세 (만원)</label>
      <div class="row2">
        <input type="number" id="inpRentMin" placeholder="최소">
        <input type="number" id="inpRentMax" placeholder="최대">
      </div>
    </div>
  </div>
  <div class="sheet-foot">
    <button type="button" class="reset" data-reset-deal>초기화</button>
    <button type="button" class="ok" data-apply-deal>확인</button>
  </div>
</div>

<div class="sheet-backdrop" id="backdropDate" hidden></div>
<div class="sheet" id="sheetDate" aria-hidden="true">
  <div class="sheet-head"><h3 class="sheet-title">입주 날짜</h3></div>
  <div class="sheet-body">
    <div class="date-row"><input type="date" id="inpMoveIn"></div>
  </div>
  <div class="sheet-foot">
    <button type="button" class="reset" data-reset-date>초기화</button>
    <button type="button" class="ok" data-apply-date>확인</button>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  (function initFromQuery(){
    const pt = "{{ request.GET.property_type|default_if_none:'' }}";
    if(pt) selectChip("#typeChips", pt);

    const dealStr = "{{ request.GET.deal_types|default_if_none:'' }}";
    if(dealStr){ dealStr.split(",").forEach(v => selectChip("#dealChips", v.trim())); }
    $("#inpDepositMin").value = "{{ request.GET.deposit_min }}";
    $("#inpDepositMax").value = "{{ request.GET.deposit_max }}";
    $("#inpRentMin").value    = "{{ request.GET.rent_min }}";
    $("#inpRentMax").value    = "{{ request.GET.rent_max }}";
    $("#inpMoveIn").value     = "{{ request.GET.move_in_from }}";
  })();

  function openSheet(id){
    $("#"+id).classList.add("open");
    const bd = $("#backdrop"+id.replace("sheet",""));
    bd.hidden=false; bd.style.opacity=1; bd.style.visibility='visible';
  }
  function closeSheet(id){
    $("#"+id).classList.remove("open");
    const bd = $("#backdrop"+id.replace("sheet",""));
    bd.style.opacity=0; setTimeout(()=>{bd.hidden=true; bd.style.visibility='hidden';},200);
  }
  function selectChip(containerSel, value){
    $$(containerSel+" .chip").forEach(ch=>{
      ch.classList.toggle("active", ch.dataset.value===value || (value==="" && ch.dataset.value===""));
    });
  }

  // 매물유형
  $("#btnType").addEventListener("click", ()=> openSheet("sheetType"));
  $("#backdropType").addEventListener("click", ()=> closeSheet("sheetType"));
  $$("#typeChips .chip").forEach(ch=> ch.addEventListener("click", ()=> selectChip("#typeChips", ch.dataset.value)));
  document.querySelector("[data-reset-type]").addEventListener("click", ()=> selectChip("#typeChips",""));
  document.querySelector("[data-apply-type]").addEventListener("click", ()=>{
    const active = $("#typeChips .chip.active");
    const val = active ? active.dataset.value : "";
    $("#property_type").value = val;
    $("#labelType").textContent = val || "전체";
    closeSheet("sheetType");
  });

  // 거래유형/가격
  $("#btnDeal").addEventListener("click", ()=> openSheet("sheetDeal"));
  $("#backdropDeal").addEventListener("click", ()=> closeSheet("sheetDeal"));
  $$("#dealChips .chip").forEach(ch=> ch.addEventListener("click", ()=> ch.classList.toggle("active")));
  document.querySelector("[data-reset-deal]").addEventListener("click", ()=>{
    $$("#dealChips .chip").forEach(ch=> ch.classList.remove("active"));
    ["inpDepositMin","inpDepositMax","inpRentMin","inpRentMax"].forEach(id=> $("#"+id).value="");
  });
  document.querySelector("[data-apply-deal]").addEventListener("click", ()=>{
    const types = $$("#dealChips .chip.active").map(ch=> ch.dataset.value).join(",");
    $("#deal_types").value = types;
    $("#deposit_min").value = $("#inpDepositMin").value;
    $("#deposit_max").value = $("#inpDepositMax").value;
    $("#rent_min").value    = $("#inpRentMin").value;
    $("#rent_max").value    = $("#inpRentMax").value;

    const label = [];
    label.push(types || "전체");
    const rmin = $("#inpRentMin").value, rmax=$("#inpRentMax").value;
    if(rmin || rmax) label.push(`월세 ${rmin||"-"}~${rmax||"-"}`);
    $("#labelDeal").textContent = label.join(" · ");
    closeSheet("sheetDeal");
  });

  // 입주 날짜
  $("#btnDate").addEventListener("click", ()=> openSheet("sheetDate"));
  $("#backdropDate").addEventListener("click", ()=> closeSheet("sheetDate"));
  document.querySelector("[data-reset-date]").addEventListener("click", ()=> { $("#inpMoveIn").value=""; });
  document.querySelector("[data-apply-date]").addEventListener("click", ()=>{
    const v = $("#inpMoveIn").value;
    $("#move_in_from").value = v;
    $("#labelDate").textContent = v || "선택";
    closeSheet("sheetDate");
  });
</script>
</body>
</html>
