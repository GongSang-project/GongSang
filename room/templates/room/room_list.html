<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ display_region }} 방 검색 결과</title>
  <style>
    :root { --sheet-radius:16px; --btn:#f0643b; --chip:#f27d5b18; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin: 12px 0 18px; }
    .toolbtn { display:inline-flex; align-items:center; gap:6px; padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px; background:#fff; cursor:pointer; }
    .toolbtn .value { color:#111; font-weight:600; }
    .toolbtn small { color:#666; }
    .applybar { display:flex; gap:10px; }
    .applybar .reset { background:#fff; border:1px solid #eee; }
    .applybar .ok { background:var(--btn); color:#fff; }
    .rooms { display:grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 18px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .meta { font-size: 13px; color:#666; }
    .pager { margin-top: 16px; display:flex; gap:8px; align-items:center; }
    .pager a { padding:6px 10px; border:1px solid #ddd; border-radius:8px; text-decoration:none; }

    /* bottom sheet */
    .sheet-backdrop{position:fixed;inset:0;background:#0006;opacity:0;visibility:hidden;transition:.2s;z-index:20;}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:var(--sheet-radius);border-top-right-radius:var(--sheet-radius);box-shadow:0 -8px 30px #0002;transition:.3s;z-index:21;}
    .sheet.open{bottom:0;}
    .sheet-head{padding:14px 18px 6px;border-bottom:1px solid #f1f1f1;}
    .sheet-title{margin:0;font-size:16px;font-weight:700;}
    .sheet-body{padding:14px 18px 18px; display:grid; gap:14px;}
    .chips{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{padding:8px 12px; border-radius:10px; border:1px solid #eee; background:var(--chip); cursor:pointer;}
    .chip.active{border-color:var(--btn); background:#ffece7;}
    .section label{display:block; margin-bottom:6px; font-weight:600;}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:8px;}
    .range{display:flex; align-items:center; gap:10px;}
    .range input[type="number"]{width:100%; padding:10px; border:1px solid #eee; border-radius:10px;}
    .sheet-foot{padding:12px 18px 18px; border-top:1px solid #f4f4f4; display:flex; gap:10px;}
    .sheet-foot button{flex:1; padding:12px; border-radius:12px; border:1px solid #eee; cursor:pointer; font-weight:600;}
    /* date sheet */
    .date-row{display:flex; gap:10px;}
    .date-row input{flex:1; padding:10px; border:1px solid #eee; border-radius:10px;}
    @media (max-width: 960px){ .rooms{grid-template-columns: repeat(2, 1fr);} }
  </style>
</head>
<body>
<div class="container">
  <h2 style="margin-bottom:8px;">
    {{ display_region }} <small style="color:#666; font-weight:400;">(전체 {{ total }}개)</small>
  </h2>

  <!-- 검색 폼: GET -->
  <form method="get" id="roomFilterForm">
    <!-- 기존 검색어/지역 입력은 숨김 유지(필요 시 노출해서 같이 씀) -->
    <input type="hidden" name="q" value="{{ request.GET.q }}">
    <input type="hidden" name="region" value="{{ request.GET.region }}">
    <!-- 신규 필터 hidden 값들 -->
    <input type="hidden" name="property_type" id="property_type" value="{{ request.GET.property_type }}">
    <input type="hidden" name="deal_types" id="deal_types" value="{{ request.GET.deal_types }}">
    <input type="hidden" name="deposit_min" id="deposit_min" value="{{ request.GET.deposit_min }}">
    <input type="hidden" name="deposit_max" id="deposit_max" value="{{ request.GET.deposit_max }}">
    <input type="hidden" name="rent_min" id="rent_min" value="{{ request.GET.rent_min }}">
    <input type="hidden" name="rent_max" id="rent_max" value="{{ request.GET.rent_max }}">
    <input type="hidden" name="move_in_from" id="move_in_from" value="{{ request.GET.move_in_from }}">

    <!-- 상단 툴바 버튼들 -->
    <div class="toolbar">
      <button type="button" class="toolbtn" id="btnType">
        <small>매물유형</small>
        <span class="value" id="labelType">{{ request.GET.property_type|default:"전체" }}</span>
      </button>
      <button type="button" class="toolbtn" id="btnDeal">
        <small>거래유형/가격</small>
        <span class="value" id="labelDeal">
          {% if request.GET.deal_types %}
            {{ request.GET.deal_types }}{% if request.GET.rent_min or request.GET.rent_max %} · 월세 {{ request.GET.rent_min|default:"-" }}~{{ request.GET.rent_max|default:"-" }}{% endif %}
          {% else %}전체{% endif %}
        </span>
      </button>
      <button type="button" class="toolbtn" id="btnDate">
        <small>입주 날짜</small>
        <span class="value" id="labelDate">{{ request.GET.move_in_from|default:"선택" }}</span>
      </button>

      <div style="margin-left:auto;">
        <div class="applybar">
          <a class="toolbtn reset" href="{% url 'room:room_list_page' %}">초기화</a>
          <button class="toolbtn ok" type="submit" style="border:none;">검색</button>
        </div>
      </div>
    </div>
  </form>

  <!-- ===== 매물유형 시트 ===== -->
  <div class="sheet-backdrop" id="backdropType" hidden></div>
  <div class="sheet" id="sheetType" aria-hidden="true">
    <div class="sheet-head"><h3 class="sheet-title">매물 유형</h3></div>
    <div class="sheet-body">
      <div class="chips" id="typeChips">
        <!-- 단일 선택 -->
        <span class="chip" data-value="">전체</span>
        <span class="chip" data-value="아파트">아파트</span>
        <span class="chip" data-value="빌라">빌라</span>
        <span class="chip" data-value="오피스텔">오피스텔</span>
        <span class="chip" data-value="주택">주택</span>
      </div>
    </div>
    <div class="sheet-foot">
      <button type="button" class="reset" data-reset-type>초기화</button>
      <button type="button" class="ok" data-apply-type>확인</button>
    </div>
  </div>

  <!-- ===== 거래유형/가격 시트 ===== -->
  <div class="sheet-backdrop" id="backdropDeal" hidden></div>
  <div class="sheet" id="sheetDeal" aria-hidden="true">
    <div class="sheet-head"><h3 class="sheet-title">거래 방식 · 가격</h3></div>
    <div class="sheet-body">
      <div class="section">
        <label>거래 방식 (중복 선택 가능)</label>
        <div class="chips" id="dealChips">
          <span class="chip" data-value="체험입주">체험 입주</span>
          <span class="chip" data-value="월세">월세</span>
        </div>
      </div>
      <div class="section">
        <label>보증금 (만원)</label>
        <div class="row">
          <input type="number" id="inpDepositMin" placeholder="최소">
          <input type="number" id="inpDepositMax" placeholder="최대">
        </div>
      </div>
      <div class="section">
        <label>월세 (만원)</label>
        <div class="row">
          <input type="number" id="inpRentMin" placeholder="최소">
          <input type="number" id="inpRentMax" placeholder="최대">
        </div>
      </div>
    </div>
    <div class="sheet-foot">
      <button type="button" class="reset" data-reset-deal>초기화</button>
      <button type="button" class="ok" data-apply-deal>확인</button>
    </div>
  </div>

  <!-- ===== 입주 날짜 시트 ===== -->
  <div class="sheet-backdrop" id="backdropDate" hidden></div>
  <div class="sheet" id="sheetDate" aria-hidden="true">
    <div class="sheet-head"><h3 class="sheet-title">입주 날짜</h3></div>
    <div class="sheet-body">
      <div class="date-row">
        <input type="date" id="inpMoveIn">
      </div>
    </div>
    <div class="sheet-foot">
      <button type="button" class="reset" data-reset-date>초기화</button>
      <button type="button" class="ok" data-apply-date>확인</button>
    </div>
  </div>

  <!-- ===== 목록 ===== -->
  <div class="rooms">
    {% for r in page_obj %}
      <div class="card">
        <div class="meta">{{ r.created_at|date:"Y-m-d" }} · {{ r.nearest_subway|default:"역 정보 없음" }}</div>
        <h3 style="margin:6px 0;">
          {{ r.address_city }} {{ r.address_district }} {{ r.address_detailed }}
        </h3>
        <div>보증금 {{ r.deposit|floatformat:0 }} / 월세 {{ r.rent_fee|floatformat:0 }}</div>
        <div class="meta">{{ r.area }}㎡ · {{ r.floor }}</div>
        <div style="margin-top:8px;">
          <a href="{% url 'room:room_detail' r.id %}">상세보기</a>
        </div>
      </div>
    {% empty %}
      <p>조건에 맞는 방이 없습니다.</p>
    {% endfor %}
  </div>

  <div class="pager">
    {% if page_obj.has_previous %}<a href="?{{ prev_qs }}">이전</a>{% endif %}
    <span>페이지 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}<a href="?{{ next_qs }}">다음</a>{% endif %}
  </div>
</div>

<script>
  // 유틸
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // 초기 값 세팅(서버에서 온 쿼리 유지)
  (function initFromQuery(){
    const pt = "{{ request.GET.property_type|default_if_none:'' }}";
    if(pt) selectChip("#typeChips", pt);

    const dealStr = "{{ request.GET.deal_types|default_if_none:'' }}";
    if(dealStr){
      dealStr.split(",").forEach(v => selectChip("#dealChips", v.trim()));
    }
    $("#inpDepositMin").value = "{{ request.GET.deposit_min }}";
    $("#inpDepositMax").value = "{{ request.GET.deposit_max }}";
    $("#inpRentMin").value = "{{ request.GET.rent_min }}";
    $("#inpRentMax").value = "{{ request.GET.rent_max }}";
    $("#inpMoveIn").value = "{{ request.GET.move_in_from }}";
  })();

  function openSheet(id){
    $("#"+id).classList.add("open");
    $("#backdrop"+id.replace("sheet","")).hidden=false;
    $("#backdrop"+id.replace("sheet","")).style.opacity=1;
    $("#backdrop"+id.replace("sheet","")).style.visibility='visible';
  }
  function closeSheet(id){
    $("#"+id).classList.remove("open");
    const bd = $("#backdrop"+id.replace("sheet",""));
    bd.style.opacity=0; setTimeout(()=>{bd.hidden=true; bd.style.visibility='hidden';},200);
  }
  function selectChip(containerSel, value){
    $$(containerSel+" .chip").forEach(ch=>{
      ch.classList.toggle("active", ch.dataset.value===value || (value==="" && ch.dataset.value===""));
    });
  }

  // 매물유형
  $("#btnType").addEventListener("click", ()=> openSheet("sheetType"));
  $("#backdropType").addEventListener("click", ()=> closeSheet("sheetType"));
  $$("#typeChips .chip").forEach(ch=> ch.addEventListener("click", ()=>{
    selectChip("#typeChips", ch.dataset.value);
  }));
  document.querySelector("[data-reset-type]").addEventListener("click", ()=> selectChip("#typeChips",""));
  document.querySelector("[data-apply-type]").addEventListener("click", ()=>{
    const active = $("#typeChips .chip.active");
    const val = active ? active.dataset.value : "";
    $("#property_type").value = val;
    $("#labelType").textContent = val || "전체";
    closeSheet("sheetType");
  });

  // 거래유형/가격
  $("#btnDeal").addEventListener("click", ()=> openSheet("sheetDeal"));
  $("#backdropDeal").addEventListener("click", ()=> closeSheet("sheetDeal"));
  $$("#dealChips .chip").forEach(ch=> ch.addEventListener("click", ()=> ch.classList.toggle("active")));
  document.querySelector("[data-reset-deal]").addEventListener("click", ()=>{
    $$("#dealChips .chip").forEach(ch=> ch.classList.remove("active"));
    ["inpDepositMin","inpDepositMax","inpRentMin","inpRentMax"].forEach(id=> $("#"+id).value="");
  });
  document.querySelector("[data-apply-deal]").addEventListener("click", ()=>{
    const types = $$("#dealChips .chip.active").map(ch=> ch.dataset.value).join(",");
    $("#deal_types").value = types;
    $("#deposit_min").value = $("#inpDepositMin").value;
    $("#deposit_max").value = $("#inpDepositMax").value;
    $("#rent_min").value    = $("#inpRentMin").value;
    $("#rent_max").value    = $("#inpRentMax").value;

    const label = [];
    label.push(types || "전체");
    const rmin = $("#inpRentMin").value, rmax=$("#inpRentMax").value;
    if(rmin || rmax) label.push(`월세 ${rmin||"-"}~${rmax||"-"}`);
    $("#labelDeal").textContent = label.join(" · ");
    closeSheet("sheetDeal");
  });

  // 입주 날짜
  $("#btnDate").addEventListener("click", ()=> openSheet("sheetDate"));
  $("#backdropDate").addEventListener("click", ()=> closeSheet("sheetDate"));
  document.querySelector("[data-reset-date]").addEventListener("click", ()=> { $("#inpMoveIn").value=""; });
  document.querySelector("[data-apply-date]").addEventListener("click", ()=>{
    const v = $("#inpMoveIn").value;
    $("#move_in_from").value = v;
    $("#labelDate").textContent = v || "선택";
    closeSheet("sheetDate");
  });
</script>
</body>
</html>
